<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="upload-split">
    <template>
        <style>
            :host {
            }
        </style>

        [[sendCount]] / [[sendMaxCount]]<br>

        <input type="file" name="file" id="file">
        <button type="button" id="btn" on-click="uploadButtonClick">upload</button>

        <iron-ajax
                id="ajax"
                url=[[url]]
                method=[[method]]
                headers=[[headers]]
                content-type=[[contentType]]
                body=[[body]]
                on-response="handleResponse"
                debounce-duration="300"></iron-ajax>

    </template>
    <script>
        class UploadSplit extends Polymer.Element {
            static get is () { return 'upload-split'; }

            static get properties () {
                return {
                    url        : {
                        type : String,
                        value: '',
                    },
                    method     : {
                        type : String,
                        value: '',
                    },
                    headers    : {
                        type : Object,
                        value: '',
                    },
                    contentType: {
                        type : String,
                        value: '',
                    },
                    body       : {
                        type : Blob,
                        value: null,
                    },
                    mime        : {
                        type : String,
                        value: null,
                    },
                    extention   : {
                        type : String,
                        value: null,
                    },
                    filename    : {
                        type : String,
                        value: null,
                    },
                    fileSize    : {
                        type : Number,
                        value: 0,
                    },
                    sendCount   : {
                        type : Number,
                        value: 0,
                    },
                    sendMaxCount: {
                        type : Number,
                        value: 0,
                    },
                };
            }

            uploadButtonClick () {
                if (this.sendCount === this.sendMaxCount) {
                    // reset count
                    this.sendCount = 0;
                    this.sendMaxCount = 0;

                    // execute
                    this.readBlob ();
                }
            }

            readBlob (chunkSize) {
                chunkSize = chunkSize || 1024 * 1000 * 5;

                const files = this.$.file.files;

                if (files.length < 1) {
                    console.log ('not find file');
                    return false;
                }

                const file = files[0];
                this.mime = file['type'];
                this.filename = file['name'];
                this.fileSize = file['size'];
                this.extension = UploadSplit.getExtensionFromFileName (this.filename);

                // count of repeat
                const chunks = Math.ceil (file.size / chunkSize);
                this.sendMaxCount = chunks;

                for (let i = 0; i < chunks; i++) {
                    this.chunk (file, i, chunks, chunkSize);
                }
            }

            chunk (file, i, chunks, chunkSize) {
                const reader = new FileReader ();

                const start = i * chunkSize;
                const stop = start + chunkSize;

                const blob = file.slice (start, stop);

                reader.onloadend = (evt) => {
                    if (evt.target.readyState === FileReader.DONE) {
                        const blob = evt.target.result;
                        (this.upload (blob, i, chunks - 1));
                    }
                };
                reader.readAsArrayBuffer (blob);
            }

            upload (blob, id, maxId) {
                this.url = 'http://localhost:8000/api/fileupload';
                this.method = 'POST';
                this.headers = {
                    'Chunk-Id'      : id,
                    'Chunk-Max-Id'  : maxId,
                    'FILE-MIME'     : this.mime,
                    'FILE-EXTENSION': this.extension,
                };
                this.contentType = 'application/octet-stream';

                this.body = blob;

                this.$.ajax.generateRequest ();
            }

            handleResponse (res) {
                console.log (res);

                this.sendCount++;
            }

            static getExtensionFromFileName (fileName) {
                const re = /(?:\.([^.]+))?$/;
                return re.exec (fileName)[1];
            }
        }

        window.customElements.define (UploadSplit.is, UploadSplit);
    </script>
</dom-module>
